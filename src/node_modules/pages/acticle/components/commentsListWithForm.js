import {
  useContext,
  useEffect
} from "react";
import { Link } from "react-router-dom";

import useFetch from 'hooks/useFetch';
import CommentsForm from 'pages/acticle/components/commentForm';
import CommentsList from "pages/acticle/components/commentsList";
import { CurrentUserContext } from "contexts/currentUser";

const CommentsListWithForm = ({ slug, authorImage, isAuthor }) => {
  const apiUrl = `/articles/${slug}/comments`;
  const [
    { response: fetchCommentsResponse }, doFetchComments] = useFetch(apiUrl);
  const [{
    response: fetchResponseAfterPostComment,
    isLoading: fetchCommentIsPosting,
    error: fetchCommentError },
    doPostComment
  ] = useFetch(apiUrl);
  const [currentUserState] = useContext(CurrentUserContext);

  useEffect(() => {
    doFetchComments();
  }, [doFetchComments]);

  useEffect(() => {
    if (!fetchResponseAfterPostComment) {
      return;
    }

    doFetchComments();
  }, [fetchResponseAfterPostComment]);

  return (
    <div className='row'>
      <div className='col-xs-12 col-md-8 offset-md-2'>
        {currentUserState.isLoggedIn ? (
          <CommentsForm
            isAuthor={isAuthor}
            authorImage={authorImage}
            doPostComment={doPostComment}
            isLoading={fetchCommentIsPosting}
            errors={(fetchCommentError && fetchCommentError.errors) || {}}
          />
        ) : (
          <div>
            <Link to='/login'>Sign in</Link> {' '}
            or {' '}
            <Link to='/register'>sign up</Link> {' '}
            to add comments on this article.
          </div>
        )}
        {fetchCommentsResponse && (
          <CommentsList
            slug={slug}
            comments={fetchCommentsResponse.comments}
            doFetchComments={doFetchComments}
            isAuthor={isAuthor}
          />
        )}
      </div>
    </div>
  );
};

export default CommentsListWithForm;